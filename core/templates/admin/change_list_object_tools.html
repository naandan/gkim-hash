{% load i18n admin_urls %}

{% block object-tools-items %}
  {% if has_add_permission %}
  <li>
    {% include "views/modal.html" %}
    {% url cl.opts|admin_urlname:'add' as add_url %}
    {% for btn in cl.model_admin.custom_button %}
    {% if btn.childlinks %}
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
          {{btn.name}}
        </button>
        <div class="dropdown-menu">
          {% for period in btn.periods %} 
            <a class="dropdown-item" href="#" data-period-id="{{ period.id }}">{{ period.name }}</a>
          {% endfor %}
        </div>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
      <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      
      <script>
        $('.dropdown-item').click(function(e) {
          e.preventDefault();
          const periodId = $(this).data('period-id');
          const periodName = $(this).text();
      
          Swal.fire({
              title: 'Konfirmasi Penyalinan',
              text: `Anda yakin ingin menyalin data ke periode ${periodName}?`,
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Ya, Salin Data',
              cancelButtonText: 'Batal'
            }).then((result) => {
              if (result.isConfirmed) {
                $.ajax({
                  url: '.', 
                  type: 'POST',
                  data: {
                    source_period_id: '{{ btn.source_period_id }}',  
                    target_period_id: periodId,   
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                  },
                  success: function(response) {
                    Swal.fire({
                      title: response.success ? 'Berhasil!' : 'Gagal!',
                      text: response.message,
                      icon: response.success ? 'success' : 'error',
                      confirmButtonText: 'OK'
                    }).then((result) => {
                        if (response.success && result.isConfirmed) {
                            location.reload(); 
                        }
                    });
                    },
                error: function() {
                  Swal.fire('Error', 'Terjadi kesalahan saat menyalin data.', 'error');
                }
              });
            }
          });
      });
      </script>
    {% elif btn.type  %}
      <a hx-get="{{ btn.link }}" hx-target="{{ btn.target }}" hx-on="click:fetch">{{btn.name}}</a>
    {% else %}
      <a href="{{ btn.link }}" id="btn-{{ btn.name|slugify }}">{{btn.name}}</a>
    {% endif %}
    {% endfor %}
    {% if cl.model_admin.admin_add_url %}
    <a href="{{ cl.model_admin.admin_add_url }}" class="addlink">
      {% else %}
      <a href="{% add_preserved_filters add_url is_popup to_field %}" class="addlink">
        {% endif %}
        {% blocktranslate with cl.opts.verbose_name as name %}Add {{ name }}{% endblocktranslate %}
      </a>
    </li>
    {% endif %}
{% endblock %}